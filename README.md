# docker-mysql-cluster

## ðŸ“š æ¦‚è¦
ç§ç”¨ã§ä½œã£ãŸmysql8ç³»ã®ã‚¯ãƒ©ã‚¹ã‚¿ãƒŽãƒ¼ãƒ‰ä½œæˆç”¨docker-composeã¨ãã®ä»–è«¸ã€…  
åŸºæœ¬pythonã§ã‚³ãƒ³ãƒ†ãƒŠã®å¤–ã‹ã‚‰åˆ¶å¾¡ã—ãŸã„  

## ðŸŒ æ¤œè¨¼ç’°å¢ƒ
- ubuntu :20.04lts

## âš™ ä½¿ç”¨æ³•
- ãƒŽãƒ¼ãƒ‰ç”Ÿæˆ
    1. ãƒŽãƒ¼ãƒ‰è¨­å®šã‚¹ã‚¯ãƒªãƒ—ãƒˆ `config.py`
        å¿œç­”ã§å¿…è¦æƒ…å ±ã‚’.envã«æ›¸ãå‡ºã—ãŸã‚Šmysqlç”¨confã‚„ãƒ­ã‚°ã‚¤ãƒ³ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã™ã‚‹ã€‚  
        - masterã‚’ä½œã‚‹å ´åˆ  
        `python3 config.py master`  
        - slaveã‚’ä½œã‚‹å ´åˆ  
        `python3 config.py slave`  
        - 1master/slaveã‚’å€‹åˆ¥è¨­å®šï¼ˆï¼‘ãƒ›ã‚¹ãƒˆã‚¯ãƒ©ã‚¹ã‚¿ç­‰ï¼‰ã®å ´åˆã¯masterãƒ»slaveã®ä¸¡æ–¹å®Ÿè¡Œ
    1. (åˆå›žã®ã¿)ã‚¤ãƒ¡ãƒ¼ã‚¸ä½œæˆ  
        `docker-compose build`
    1. (ä»»æ„)sqlã®åˆæœŸãƒ‡ãƒ¼ã‚¿ã®è¿½åŠ   
        - `./mnt/sh_init/`ã®`masetr`ã¨`slave`ã«dumpãã®ä»–ãƒ‡ãƒ¼ã‚¿ã‚’å…¥ã‚Œã¦ãŠã‘ã°ã‚³ãƒ³ãƒ†ãƒŠç”Ÿæˆæ™‚ã«ãƒ‡ãƒ¼ã‚¿ãŒè¿½åŠ ã•ã‚Œã‚‹ã€‚  
        (ãƒ•ã‚¡ã‚¤ãƒ«åæ˜‡é †ã§å®Ÿæ–½ã•ã‚Œã‚‹ãŸã‚æ³¨æ„ã€‚åŸºæœ¬ã¯ãƒŠãƒ³ãƒãƒªãƒ³ã‚°ã§ç®¡ç†ãŒç„¡é›£)  
        * ã‚¨ã‚¯ã‚»ãƒ«ã§åˆæœŸãƒ†ãƒ¼ãƒ–ãƒ«ã®sqlãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ  
            - `./mnt/sh_init/constants.xlsm`ã®ã‚’ç·¨é›†ã—ã¦ãƒžã‚¯ãƒ­å®Ÿè¡Œã§ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ`.sql`ã¨fastapiç”¨ã®validator`.py`ã‚’ä½œæˆå¯èƒ½ã€‚  
    1. ã‚³ãƒ³ãƒ†ãƒŠç”Ÿæˆ
        `python3 init.py`  
        - å¿œç­”ã¯åŸºæœ¬'y'ã§ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚„logã®å‰Šé™¤ã¯éƒ½åº¦åˆ¤æ–­ã€‚dumpã¯ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‹ã‚‰åˆ¶å¾¡ã—ãªã„ã€‚
        - nodeã®ç¨®é¡žã‚’åˆ‡ã‚Šæ›¿ãˆãŸã„å ´åˆ`config.py`ã‚’äº‹å‰ã«å®Ÿè¡Œã—ã¦ã‹ã‚‰ã€ç”Ÿæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã€‚
        - 1ãƒ›ã‚¹ãƒˆã§master/slaveæ§‹æˆã—ãŸã„å ´åˆ  
        `python3 init.py all`  

- ãƒ€ãƒ³ãƒ—ãƒ»ãƒªã‚¹ãƒˆã‚¢
    - ãƒ€ãƒ³ãƒ—ä½œæˆ  
        `sudo python3 rep/dump.py`  
        - 1ãƒ›ã‚¹ãƒˆã‚¯ãƒ©ã‚¹ã‚¿ã®å ´åˆã¯ä¸‹è¨˜ã®ã‚ˆã†ã«ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§nodeå¼·åˆ¶  
            `sudo python3 rep/dump.py -n master`  
            - ã‚ªãƒ—ã‚·ãƒ§ãƒ³  
                - `--all` or `-a`: `--all-databases`ã§dumpä½œæˆ  
                - `--compress` or `-c`: ä½œæˆã•ã‚ŒãŸdumpã®zipåœ§ç¸®ãƒ•ã‚¡ã‚¤ãƒ«ã‚‚ä½œæˆ  
                - `--node` or `-n`: 1ãƒ›ã‚¹ãƒˆã‚¯ãƒ©ã‚¹ã‚¿æ™‚ã«ä½¿ç”¨ã€‚ãƒŽãƒ¼ãƒ‰å¼·åˆ¶  
    - ãƒªã‚¹ãƒˆã‚¢(ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ‡ã‚¿ãƒƒãƒãƒ»ã‚¢ã‚¿ãƒƒãƒå‡¦ç†å…¼ç”¨)  
        `python3 rep/restore.py`  
        - 1ãƒ›ã‚¹ãƒˆã‚¯ãƒ©ã‚¹ã‚¿ã®å ´åˆã¯ä¸‹è¨˜ã®ã‚ˆã†ã«ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§nodeå¼·åˆ¶  
            `python3 rep/restore.py -n slave`  
        - slaveãƒŽãƒ¼ãƒ‰ã§å®Ÿæ–½ã—ãŸå ´åˆã®ã¿ãƒ‡ã‚¿ãƒƒãƒã¨ã‚¢ã‚¿ãƒƒãƒãƒªã‚¹ãƒˆã‚¢ã®å‰å¾Œã«å®Ÿæ–½ã•ã‚Œã‚‹  
    - (slaveé™å®š)ãƒ‡ã‚¿ãƒƒãƒ  
        `python3 rep/detach.py`  
        - ã‚ªãƒ—ã‚·ãƒ§ãƒ³  
            - `--node` or `-n`: 1ãƒ›ã‚¹ãƒˆã‚¯ãƒ©ã‚¹ã‚¿æ™‚ã«ä½¿ç”¨ã€‚ãƒŽãƒ¼ãƒ‰å¼·åˆ¶  
    - (slaveé™å®š)ã‚¢ã‚¿ãƒƒãƒ  
        `python3 rep/attach.py`  
        - ã‚ªãƒ—ã‚·ãƒ§ãƒ³  
            - `--file` or `-f`: ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«æŒ‡å®š  
            - `--pos` or `-p`: ãƒ­ã‚°ãƒã‚¸ã‚·ãƒ§ãƒ³æŒ‡å®š  
            - `--node` or `-n`: 1ãƒ›ã‚¹ãƒˆã‚¯ãƒ©ã‚¹ã‚¿æ™‚ã«ä½¿ç”¨ã€‚ãƒŽãƒ¼ãƒ‰å¼·åˆ¶  

## ðŸ’¨ ãŠæ‰‹è»½ï¼‘ãƒ›ã‚¹ãƒˆã‚¯ãƒ©ã‚¹ã‚¿æ§‹ç¯‰

- ãƒŽãƒ¼ãƒ‰ä½œæˆ
    * masterã¨slaveãƒŽãƒ¼ãƒ‰ã®è¨­å®š  
      `python3 config.py all`
    * masterãƒŽãƒ¼ãƒ‰ã¨slaveãƒŽãƒ¼ãƒ‰ã®ã‚³ãƒ³ãƒ†ãƒŠä½œæˆ  
      `sudo python3 init.py -y`
      * `[info] yyyy-mm-dd hh:ii:ss - initialize end.`ã¨è¡¨ç¤ºã•ã‚Œã¦ã‚³ãƒ³ãƒ†ãƒŠç”Ÿæˆå®Œäº†
    * masterãƒŽãƒ¼ãƒ‰ã®ãƒ€ãƒ³ãƒ—ä½œæˆå®Œäº†  
      `sudo python3 rep/dump.py -n master`
    * masterã‹ã‚‰slaveã«dumpã‚’ã‚³ãƒ”ãƒ¼  
      `sudo cp -r vol/master/dump/{ä»»æ„ã®dump} vol/slave/dump`
    * masterãƒŽãƒ¼ãƒ‰ã‹ã‚‰slaveãƒŽãƒ¼ãƒ‰ã«ãƒªã‚¹ãƒˆã‚¢  
      `python3 rep/restore.py -n slave`
      * ãƒ‡ã‚¿ãƒƒãƒã™ã‚‹ã‹ -> `y`
      * ãƒªã‚¹ãƒˆã‚¢å¯¾è±¡ -> dumpãƒ•ã‚©ãƒ«ãƒ€ä¸€è¦§è¡¨ç¤ºã‹ã‚‰ã‚³ãƒ”ãƒš
      * ã‚¢ã‚¿ãƒƒãƒã™ã‚‹ã‹ -> `y`
